# DEX

- AMM



## AMM

几种AMM类型：**恒定总和做市商(CSMM)**、**恒定平均值做市商(CMMM)**和**混合常数函数做市商（CFMM）**。

AMM必须克服的一些关键挑战，包括：**套利损失**（Impermanent Loss）、**多代币敞口**（ forced multi-token exposure）和**低资本效率**。

### CPMM

假设我们在 Uniswap 的某个池里投入 50 个苹果 （a） 和 50 个香蕉 （b） ，任何人都可以用苹果换香蕉，或者用香蕉换苹果。假设一级市场中苹果与香蕉的**汇率刚好是 1:1**。因为该 Uniswap 资金池中分别有 50 个苹果和 50 个香蕉，因此，按上述常数积的等式规则，a * b = 2500 。对于任何交易，Uniswap 都需要保证，池中库存的苹果数和香蕉数相乘等于 2500。

好了，假设一位客户进入我们的 Uniswap 池来买一个苹果。她应该支付多少个香蕉呢？

如果她买走一个苹果，我们的池里就剩下 49 个苹果，而 49* b 依然需要等于 2500。这样香蕉的总数 b 就等于 51.02。由于之前池中有 50 个香蕉，因此我们**还需要 1.02 个香蕉**（在这个宇宙中我们允许碎片化香蕉的存在） ，因此，这位客户买一个苹果会得到的报价是：1.02 香蕉 / 苹果。

请注意，这与两者之间 1:1 的原始价格很接近！因为这只是一笔小额交易，所以滑点较小。但如果订单很大呢？

![img](https://pic4.zhimg.com/50/v2-d2f1785429ebe01c4ac566bae1d034d9_hd.webp?source=1940ef5c)

**这条曲线每个点的斜率解读为边际交换率**

如果苹果与香蕉之间的真实交易价格是 1:1，当第一位客户买走 10 个苹果后，我们 Uniswap 池就有会变成 40 个苹果和 62.5 个香蕉。如果有位**套利者**此时进入，她买走 12.5 个香蕉，让资金池恢复到最初状态，她只需付 10 个苹果，所以 Uniswap 对她的收费只有 0.8 苹果 / 香蕉。

稍微偏离真实的交易价格，然后**在套利者的帮助下**缓步回归正常。

### CSMM

**“恒定总和做市商”（CSMM）** ，它非常适合零滑点交易，但不能提供无限的流动性。CSMM遵循公式x + y = k，在绘制时会创建一条直线。不幸的是，如果代币之间的链下参考价格不是1：1，则这种设计允许套利者耗尽其中的一项储备。这种情况将破坏流动资金池的一侧，迫使流动资金提供者承担损失，而交易者则没有更多的流动资金。因此，CSMM是AMM的罕见模型。

![img](https://pic4.zhimg.com/80/v2-55ad1cdf02d237fb635e575a48562bc4_720w.jpg?source=1940ef5c)

### CMMM

它可以创建具有两个以上代币的AMM，并在标准的50/50分布之外进行加权。在这个模型中，每个代币储备的加权几何平均值保持不变。对于一个有三种资产的流动性池，公式如下。(x*y*z)^(⅓)=k。**这就允许池内不同资产的风险敞口可变，并可在池内任何资产之间进行互换。**

随着基于AMM的流动性的发展，我们看到了先进的混合常数函数做市商（CFMM）的出现，这些混合型常数函数做市商结合了多种功能和参数，以实现特定的行为，如调整流动性提供者的风险敞口或减少交易者的价格滑点。

![img](https://pic4.zhimg.com/80/v2-e1cc4262ab15c071352ac96b368df09f_720w.jpg?source=1940ef5c)

#### 套利损失（Impermanent Loss）

假设某家香蕉农场遭遇了无人机攻击，出现大面积的香蕉短缺。香蕉现在像黄金一样贵。交易价格蹿升到 5 个苹果换 1 个香蕉。

Uniswap 上会发生什么？

套利者一秒都不会耽搁，立马杀入你的 Uniswap 池，抢购便宜的香蕉。他们**调整交易规模**，以便买走价格低于新汇率 5:1 的所有香蕉。这意味着他们需要移动价格曲线，直到满足以下等式：5x * x = 2500。

![img](https://pic1.zhimg.com/50/v2-ae73a3f9cb50024a637c4e8945d00cdb_hd.webp?source=1940ef5c)

算一下这个数学题，你会得到如下结果：他们总共以 61.80 个苹果买到 27.64 个香蕉。平均交易价格为 2.2 个苹果：1 个香蕉，这远低于市场价，相当于得到 76.4 个免费苹果。

他们的利润从何而来？当然这是以**牺牲资金池**为代价的！而且，如果数一下你会发现，与某个持有最初的 50 个苹果和 50 个香蕉的人相比，Uniswap 池现在恰好下降了 76.4 个苹果的价值。Uniswap 出售香蕉的价格太便宜，因为它不知道香蕉在现实世界中变得如此值钱。

这种现象称为「**套利 损失」**。每当交易价格发生变动，就会出现**套利者窃取廉价资产**，直到资金池的定价达到正确为止。 （这些损失是「暂时的」，因为如果后来真实交易价格恢复为 1：1，那么就好像你从未损失过这笔钱，和开始相比。）

资金池通过**交易费**赚钱，通过套利损失而亏钱。这都是**需求和价格背离**的一个函数——需求有利于资金池，而价格背离不利于资金池。

假设你想成为 Uniswap 上 ETH / DAI 池的**流动性提供商**（LP） 。在向该池提供资金时，你必须同时相信以下两点，才会认定，成为一个 LP 比仅持有原始资产要好得多：

1. ETH 与 DAI 的**价值比**不会发生太大变化 （如果发生变化，将表现为套利损失）
2. 这个池会收到很多**交易费**

![preview](https://pic2.zhimg.com/v2-90968d6d2f8f992a93a59846ec9e8470_r.jpg?source=1940ef5c)

均值回归交易对的情况很明显。相互关联的交易对，其价格往往一起移动，因此 Uniswap 不会有太多套利损失。而像 ETH/DAI 这样不相关的交易对，情况就不太确定，有时候交易费可以弥补损失。最右边是**逆相关的交易对**，Uniswap 上这种资金池就很糟糕了。

#### 多代币敞口

AMM通常要求流动性提供者存入两种不同的代币，以便为交易双方提供同等的流动性。因此，流动性提供者无法保持对单一代币的长期风险敞口，而不得不通过持有额外的ERC20储备资产来增加其风险敞口。拥有大量一种代币的团队或希望提供流动性的个人将被迫购买另一资产，以提供流动性，从而减少他们在资产池基础代币中的持有量，并增加对另一资产的敞口。

#### 低资本效率

AMM被批评需要大量的流动资金才能达到与基于订单簿的交易所相同的滑点水平。这是由于AMM流动性的很大一部分只有在定价曲线开始转为指数时才能使用。因此，由于具有较大的滑点，大多数流动性永远不会被理性交易者使用。

AMM流动性提供者无法控制提供给交易者的价格，这导致一些人将AMM称为 "懒惰的流动性"，其利用率不高且配置不足。同时，订单簿交易所的做市商可以精确控制他们想要购买和出售代币的价格点位。这带来了非常高的资本效率，但同时也带来了需要积极参与和监督流动性供给的代价。