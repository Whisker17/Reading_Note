# Fucking DEX

DEX，decentralized exchange，即去中心化交易所，作为 DeFi 应用里的一把尖刀，在最近的半年里刷足了存在感，使得 DeFi 如同当年的 ICO 一样，让多少人瞬间达成了财务自由的白日梦。就像当年一样，大笔资金进场瞬间引爆了整个市场。Hello？不就是个交易所吗，怎么会有这样的魔力，下面我们就来见识一下 DEX 的魅力。

众所周知，我们认知里的交易所，从撮合到清算，甚至是做市的环节能做到快速稳定，必然是依托了中心化的服务。如果我们想要做到去中心化的交易所，使得自己的资产不再交给交易所托管，而是自管理，我们又该如何实施呢？

首先我们需要知道对于一个 DEX 来说，当前市场主要分成了基于**订单簿**或者**自动化做市商**两种模式。

**订单簿**

订单簿是什么呢？假如有 X 个用户，卖出 Ether ，买入 UNI ，有 Y 个对方手用户买入 UNI ，卖出 Ether ，两边的用户数量和出价都不同，DEX 则会根据**出价的高低**，**时间的先后**等原则，把双方记录在一张订单簿上，撮合合适的双方交易，从而确定这两种资产的价格，这个订单簿，中心化的交易所把它存储在交易所的服务器上，而 DEX 的订单式交易，则是在链上完成的，用户自己创建交易和取消订单，并为自己的操作支付 Gas 费用。

**AMM 自动化做市商**

在过去的几个月里，我们看到了 Uniswap 的崛起，凭借的就是 AMM 。那么什么是 AMM 呢？它又是为何成为了市场的宠儿呢？首先我们知道在股市中，**做市商**（market maker） 是指负责撮合买家和卖家，以促成交易。这些人通过**价差**（spread） 来赚钱。而 AMM 的概念也并非在 DEX 中首创， 在传统金融市场中，它们让金融人士能够建立一些必须遵循的价格关系。如果某一资产触及某个特定价格，一定数量的该资产就会被买进。AMM 这个概念在学术界已有 **10 年**的深入研究，研究主要集中在信息汇总的设计，以及如何应用于某些市场，在这些市场，回报依赖于世界的某些未来状况，例如预测市场。

人气最高的 AMM 是「**对数市场评价法则」**（ Logarithmic Market Scoring Rule，LMSR） ，该法则于 **2002** 年提出，被用于大多数**预测市场**（例如 Augur V1 和 Gnosis） 。AMM 的信息汇总还有其他策略，例如贝叶斯做市商 （在二元市场表现不俗） 和动态同注分彩做市商 （ dynamic pari-mutuel market makers）（常用于赛马） 。

在⾃动做市商（AMM）机制下，做市门槛得以降低，普通⽤户的参与程度⼤⼤提升，因此流动性的聚集也更加容易。传统市场之所以采用订单簿，是因为它们能高速运行。人们可以下单，在不到一秒内撤单。而以太坊**每 20 秒**处理一次交易区块。AMM 之所以运转良好，是因为在以太坊的每一轮，你可以投入一种代币，换回另一种代币。它在价格完善方面的欠缺，用**可预测性**进行了弥补。

## AMM 的多种模式

**常数函数做市商 CFMM** 是专门用于真实金融市场的**第一批 AMM**。它建立在一种函数之上，即依据两个或多个资产的可用数量来建立一种预先定义的价格组合。与基于订单簿的传统交易所不同，交易者是与一个**资产池、**而不是与某个特定的对手方交易。

CFMMs 通常有三个参与方：

- **交易者**：用一种资产交换另一种资产。
- **流动性提供者**(LP) ：愿意将自己的资产组合与他人进行交易，获得一定费用
- **套利者**：让该资产组合中的资产的价格保持与市场价格一致，以赚取一定利润

### 恒定乘积做市商 （Constant Product Market Makers）

![CPMM](https://img.chainnews.com/material/images/0db88ff16f16beee6ead3281c3bb2ae6.jpg-article)

R(α) 和 R(β) 分别是某种资产的储备量，γ 是交易费。交易任何数量的某种资产，当改变其储备量时，必须保证：当交易费为 0，乘积 R(α)*R(β) 一直要等于常数 k。这常被简化为 x * y=k， x 和 y 分别是两种资产的储备量。在实践中，由于 Uniswap 收取 **0.3%** 的交易费，并将其投入储备，所以每笔交易之后 k 会增大。

![CPMM](https://img.chainnews.com/material/images/76b71f4f5aa08ba249655ea93f99ee1f.jpg-article)

一个恒定乘积函数在描绘两种资产时会形成一条**双曲线**，其特性让人比较满意，**因为当价格趋近无限时 （在频谱的两端） ，流动性都不会匮乏**。

### 恒定总和做市商 （Constant Sum Market Makers）

![CSMM](https://img.chainnews.com/material/images/992062891b71166a72a93b71e98e35dd.jpg-article)

当描绘两种资产价格时，恒定总和函数会形成一条直线，结果就是等式 **x+y=k**。

### 恒定平均值做市商 （Constant Mean Market Makers）

![CMMM](https://img.chainnews.com/material/images/d4a63c5bccc542e0568c541e9bcc530f.jpg-article)

R 是每种资产的储备量， W 是每种资产的权重 ， k 是常数。换句话说，在无费用时，恒定平均值市场确保了**资产储备量**的加权几何平均值保持不变。

对于 AMM 协议的 DEX 来说，不同机制的设计其实更多的是在不同参与者（LP 和交易者）的利益之间做权衡。

## AMM 的现有问题

> **滑点本质上是为保护 LP 的利益而损害交易者的体验；而无常损失则是为保护交易者体验而损害 LP 利益。**

### 无常损失（Impermanent Loss）

在 AMM 的运作环境下，**LP 向 AMM 资⾦池提供流动性时，因资产外部市场价格波动⽽产⽣的损失。** 同时，无常损失在资产价格恢复以后可能消失。在 Uniswap 中，由于其中的资产定价和资⾦池储备相关，价格发现在链上完成，不和外部市场价格联通。因此**当外部市场资产价格波动时，Uniswap 需要依赖套利（Arbitrageurs）去修正链上价格，使其和外部市场价格达成⼀致。** 当然套利者并不会免费做这种好事，**套利者在修正链上价格的过程当中，其获得的利润便是资⾦池的损失，也因此使得 LP 和被动持有资产相比受到损失。** 若不计交易⼿续费和滑点，无常损失的具体发⽣步骤如下所示：

1. 假设 ETH/DAI 资⾦池拥有 10 个 ETH 和 5,000 个 DAI，内部价格 1ETH=500DAI，初始市场价 1ETH=500DAI。资⾦池内部价格和市场价相等，**资⾦池平衡**。
2. 假设 LP Alice 为上述资⾦池提供了 1ETH/500DAI，则 Alice 拥有上述资⾦池 10% 的股份；
3. ETH 外部市场价格上升，1ETH=700DAI，⽽资⾦池内部价格仍然为 1ETH=500DAI，**套利空间产生；**
4. 套利者 Bob 从资⾦池以 500DAI 的价格买⾛1 个 ETH，资⾦池剩余 9ETH 和 5500DAI，**资⾦池失衡，**ETH 储备减少且资⾦池内部 ETH 价格上涨，**套利空间持续存在，直至 ETH 内部价格涨至 700DAI**（外部市场价格）；
5. Alice 想在资⾦池为 9ETH/5500DAI 时撤回资⾦，Alice 实际撤回的为 10%*9ETH/5500DAI， 即 0.9ETH/550DAI。**Alice 此时的资产价值为 0.9\*700+550=1180DAI；**
6. Alice 若被动持有 1ETH/500DAI，其资产价值应当为 1*700+500=1200DAI。作为 LP，Alice 产生了 20DAI 的**无常损失。**

由上可知，**无常损失的大小和资产价格波动程度正相关，并且所有采⽤资⾦储备对资产进⾏定价、依赖套利者调整链上资产价格模式的 AMM 都⼀定存在无常损失。**取决于资产外部价格波动的大小，LP 产⽣的无常损失可能被交易⼿续费和流动性挖矿收益补偿。同时，由数学公式推导，无常损失的函数曲线形态如下图所示：

![无常损失函数曲线](https://img.chainnews.com/material/images/9087bae2e3ff0b61510a50acd4c5499a.jpg-article)

如果价格由 P 变为 P’，那么无常损失率为：

![无常损失量化](https://img.chainnews.com/material/images/bed1a5ca82415faf94ce082cf5a46013.png-article)



### 滑点

**滑点是指预期交易价格和实际成交价格之间的差值。**

这个现象在传统的交易市场也是存在的，而对于传统订单簿模式的交易所来说，只要流动性越高，盘深度越好，滑点就会越低。但是在 AMM 中，由于其采用的是资金池的方式来做市，资金池中的资产价格由函数决定，这意味着 **AMM 中交易对的价格和其交易资产在资⾦池中的储备直接相关。** 因此，⼀旦交易发⽣，导致交易资产在资⾦池中的储备变化，资产实际的交易执行价便会发⽣改变，产⽣滑点。也因此，**越是大额的、对资⾦池的流动性储备破坏越深的交易，滑点也就越高。**

AMM 滑点的⾼低还**取决于其采用的机制本身**。我们可以知道，滑点在恒定总和做市商函数下不存在。但是由于滑点的不存在，当不断进行单向交易时，可能会导致资产流动性枯竭，即 X ⾜够⼤时 Y 将为 0 。于是为了放置资金池流动性枯竭，我们必须**以滑点的方式对交易者进行限制**。

![不同做市商函数曲线](https://img.chainnews.com/material/images/3bd531fd1accbc018f6736d457d47aa2.jpg-article)

### 资金利用率低

资金利用率是金融市场的重要组成，低资金利用率意味着投资组合结构欠佳，闲置资产没有被很好地用来获取收益。流动性与交易量之间的关系可用资本利用率表示。

![不同去中心化交易所的资金利用率](https://img.chainnews.com/material/images/5880f77a95fd5219af545111b6121c97.png-article)



除此之外，还存在一种叫做**多资产风险敞口**的问题存在，即**本身只持有⼀种资产的 LP 将被迫承担多种资产的风险敞口。**

### 解决方案

当然，这些现存的问题并不会阻碍行业的发展，大家集思广益，针对这些问题想出了一系列解决方案：**针对滑点和资金利用率的问题，可采取的优化方案包括改变做市函数曲线和采用预言机对交易资产进行喂价。**但由于滑点同时能防止资金池内的资本损耗，对资金池内资产的流动性起到保护作用，故贴合 0 滑点的做市曲线仅对资产价格 1:1 的交易对具备良好应用场景。

**针对无常损失问题，优化方案同样包括引入预言机喂价，**使资金池内的价格和外部市场价格保持一致，不依赖套利者对池内价格进行修正。**同时，无常损失以及资产价格波动引起的风险还可通过对冲的方式被管理。**

而针对多资产风险敞口问题，则可通过给予 LP 单一资产资金池「股份」的形式，使 LP 仅承担单一风险敞口。

### 引入预言机之后

但是，预言机的进场并不是一个完美的解决方案，由于预言机作为一个第三方喂价工具，使得我们原本的服务多了一个被攻击的选择，这无疑也增加了 DEX 的风险。同时，我们对预言机的依赖也可能会造成一种**抢跑（Front-running）的风险**，即套利者可以通过监听预言机的价格寻找套利机会。当预言机两次报价的差值大于套利所需的交易手续费时，套利者可赚取其中的价差，使 LP 蒙受损失。

## 后续发展

